# setapp-cli v2.1 Improvements — Design

Date: 2026-03-01

## Overview

Five improvements to the `setapp-cli` tool:

1. `bundle check --path` — custom app directory for the check
2. Setapp installed + logged-in pre-flight on relevant commands
3. No header comments in AppList files
4. Bundle file renamed to AppList throughout (user-facing only)
5. Top-level `dump` command moved under `bundle`

---

## 1. `bundle check --path`

Add an optional `--path <dir>` flag to `BundleCheckCommand`.

**Semantics:**
- Without `--path`: check `/Applications/<Name>.app` and
  `~/Applications/<Name>.app` using `FileManager.fileExists`
- With `--path <dir>`: check `<dir>/<Name>.app` only

The current `Dependencies.detector.isInstalled()` call (which checks
Setapp-specific subdirectories) is replaced with a direct filesystem lookup.
The command reports an app as installed regardless of how it arrived on the
machine.

**Interface:**

```
setapp-cli bundle check [--file <path>] [--path <dir>]
```

**Error output** when apps are missing is unchanged; the message lists names
that were not found at the given path(s).

---

## 2. Setapp Installed + Logged-In Pre-flight

Add `SetappEnvironment.verify()` — a static throwing function that confirms:

1. **Installed:** `/Applications/Setapp.app` or `~/Applications/Setapp.app`
   exists on disk.
2. **Logged in:** the SQLite database at
   `~/Library/Application Support/Setapp/Default/Databases/Apps.sqlite`
   exists and has non-zero size.

Error messages are actionable:

- Not installed: `"Setapp is not installed. Download it at setapp.com."`
- Not logged in: `"Setapp is installed but you are not logged in. Open Setapp
  and sign in to continue."`

**Where it is called:** immediately after `globals.apply()` in every command
that touches the database or XPC service — `install`, `remove`, `reinstall`,
`list`, `check`, `bundle install`, `bundle dump`, `bundle check`,
`bundle list`, `bundle cleanup`. `bundle edit` is exempt (touches only a
plain-text file).

**Testability:** `SetappEnvironment` is added to `Dependencies` as a mockable
property so tests can substitute a no-op or always-pass implementation. Unit
tests that use mock dependencies are unaffected.

---

## 3. No Header in AppList Files

`AppListFile.write()` (formerly `BundleFile.write()`) writes only sorted app
names, one per line, followed by a single trailing newline. The date-stamped
header block is removed entirely.

Before:
```
# setapp bundle -- 2025-01-01
# Run `setapp bundle install` to reinstall on a new Mac.

CleanMyMac
CleanShot X
```

After:
```
CleanMyMac
CleanShot X
```

`AppListFile.parse()` already strips comment lines and blank lines, so
existing files with the old header continue to parse correctly — no migration
needed.

`BundleEditCommand` seeds new files as empty (zero bytes) rather than
writing the old header, so the user's editor opens a blank document.

---

## 4. Bundle → AppList Terminology

All user-facing references to "bundle file" are renamed to "AppList file".
The `bundle` command name itself is unchanged.

| Scope | Before | After |
|-------|--------|-------|
| Default filename | `~/.setapp/bundle` | `~/.setapp/AppList` |
| Help strings | "bundle file" | "AppList file" |
| Environment variable | `SETAPP_BUNDLE_FILE` | `SETAPP_APP_LIST_FILE` |
| Error messages | "bundle file not found" | "AppList file not found" |
| Internal type | `BundleFile` | `AppListFile` |
| URL extension property | `defaultBundlePath` | `defaultAppListPath` |
| `SetappError` case | `bundleFileNotFound` | `appListFileNotFound` |

`SETAPP_BUNDLE_FILE` is dropped without a deprecation alias.

README, `SetappCLI.swift` discussion text, all command help strings, and
`test-local.sh` are updated to reflect the new naming.

---

## 5. `dump` Moves Under `bundle`

The top-level `setapp-cli dump` command is removed. `setapp-cli bundle dump`
becomes the canonical form.

**Changes:**
- `BundleDumpCommand` gains the `--list` flag (currently only on
  `DumpCommand`): prints app names to stdout instead of writing a file.
- `DumpCommand.swift` is deleted.
- `DumpCommandTests.swift` is migrated into `BundleDumpCommandTests.swift`.
- `SetappCLI.swift` drops `DumpCommand.self` from the subcommand list and
  updates the discussion text.
- `test-local.sh` updated: `dump --list` → `bundle dump --list`,
  `dump --file` → `bundle dump --file`.

**Final command hierarchy:**

```
setapp-cli
├── install <app>
├── remove <app>
├── reinstall <app>
├── list
├── check
└── bundle
    ├── install [--file] [--replace]
    ├── dump [--file] [--list]
    ├── check [--file] [--path]
    ├── list [--file]
    ├── cleanup
    └── edit [--file]
```
